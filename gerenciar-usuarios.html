<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Usu√°rios - Firebase Auth</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .users-table td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-admin {
            background: #28a745;
            color: white;
        }

        .badge-user {
            background: #6c757d;
            color: white;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .btn-delete:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-back {
            background: #6c757d;
            color: white;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }

        .btn-back:hover {
            background: #5a6268;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-users {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë• Gerenciar Usu√°rios do Firebase</h1>
            <p>Visualize e delete usu√°rios do Firebase Authentication + Firestore</p>
        </div>

        <div class="content">
            <a href="admin.html" class="btn btn-back">‚Üê Voltar para Admin</a>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Esta p√°gina mostra TODOS os usu√°rios cadastrados no Firebase Authentication e Firestore. Voc√™ pode deletar qualquer usu√°rio (exceto admins protegidos).
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Carregando usu√°rios...</p>
            </div>

            <div id="users-container" style="display: none;">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>UID</th>
                            <th>Tipo</th>
                            <th>√öltima Atividade</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody">
                    </tbody>
                </table>
            </div>

            <div id="no-users" class="no-users" style="display: none;">
                <h3>Nenhum usu√°rio encontrado</h3>
                <p>O banco de dados est√° vazio.</p>
            </div>

            <div id="message" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Config -->
    <script src="firebase-config.js"></script>

    <script>
        const loadingDiv = document.getElementById('loading');
        const usersContainer = document.getElementById('users-container');
        const noUsersDiv = document.getElementById('no-users');
        const usersTbody = document.getElementById('users-tbody');
        const messageDiv = document.getElementById('message');

        // Carregar usu√°rios
        async function loadUsers() {
            try {
                console.log('üîÑ Carregando usu√°rios do Firestore...');

                // Buscar todos os usu√°rios do Firestore
                const usersSnapshot = await db.collection('users').get();

                if (usersSnapshot.empty) {
                    loadingDiv.style.display = 'none';
                    noUsersDiv.style.display = 'block';
                    return;
                }

                // Limpar tabela
                usersTbody.innerHTML = '';

                // Adicionar cada usu√°rio na tabela
                usersSnapshot.forEach((doc) => {
                    const userData = doc.data();
                    const row = document.createElement('tr');

                    const lastActivity = userData.lastLoginAt 
                        ? new Date(userData.lastLoginAt.toDate()).toLocaleString('pt-BR')
                        : (userData.createdAt ? new Date(userData.createdAt.toDate()).toLocaleString('pt-BR') : 'Desconhecido');

                    const isAdmin = userData.isAdmin === true;

                    row.innerHTML = `
                        <td><strong>${userData.username || 'Sem nome'}</strong></td>
                        <td>${userData.email || 'Sem email'}</td>
                        <td><code style="font-size: 11px;">${doc.id}</code></td>
                        <td>
                            <span class="badge ${isAdmin ? 'badge-admin' : 'badge-user'}">
                                ${isAdmin ? 'üëë ADMIN' : 'üë§ USU√ÅRIO'}
                            </span>
                        </td>
                        <td>${lastActivity}</td>
                        <td>
                            <button 
                                class="btn btn-delete" 
                                onclick="deleteUser('${doc.id}', '${userData.email}', ${isAdmin})"
                                ${isAdmin ? 'disabled title="Admins n√£o podem ser deletados"' : ''}
                            >
                                üóëÔ∏è Deletar
                            </button>
                        </td>
                    `;

                    usersTbody.appendChild(row);
                });

                loadingDiv.style.display = 'none';
                usersContainer.style.display = 'block';

                console.log(`‚úÖ Carregados ${usersSnapshot.size} usu√°rios`);

            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
                loadingDiv.style.display = 'none';
                messageDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545; color: #721c24;">
                        <strong>Erro ao carregar usu√°rios:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Deletar usu√°rio
        window.deleteUser = async function(uid, email, isAdmin) {
            if (isAdmin) {
                alert('‚õî Admins n√£o podem ser deletados!');
                return;
            }

            const confirmed = confirm(
                `‚ö†Ô∏è ATEN√á√ÉO!\n\n` +
                `Voc√™ est√° prestes a DELETAR o usu√°rio:\n\n` +
                `Email: ${email}\n` +
                `UID: ${uid}\n\n` +
                `Esta a√ß√£o √© IRREVERS√çVEL!\n\n` +
                `Tem certeza?`
            );

            if (!confirmed) return;

            try {
                console.log('üóëÔ∏è Deletando usu√°rio:', uid);

                // 1. Deletar do Firestore
                await db.collection('users').doc(uid).delete();
                console.log('‚úÖ Usu√°rio removido do Firestore');

                // 2. Se for o usu√°rio atual, deletar do Authentication tamb√©m
                const currentUser = auth.currentUser;
                if (currentUser && currentUser.uid === uid) {
                    await currentUser.delete();
                    console.log('‚úÖ Usu√°rio removido do Authentication');
                    
                    alert('‚úÖ Usu√°rio deletado com sucesso!\n\nVoc√™ ser√° deslogado.');
                    window.location.href = 'login.html';
                    return;
                }

                // 3. Deletar dados relacionados (opcional)
                const deleteRelated = confirm('Deletar tamb√©m os dados relacionados (workspaces, boards, etc.)?');
                
                if (deleteRelated) {
                    // Deletar workspaces do usu√°rio
                    const workspacesSnapshot = await db.collection('workspaces')
                        .where('ownerId', '==', uid)
                        .get();
                    
                    for (const doc of workspacesSnapshot.docs) {
                        await doc.ref.delete();
                    }

                    // Deletar boards do usu√°rio
                    const boardsSnapshot = await db.collection('boards')
                        .where('ownerId', '==', uid)
                        .get();
                    
                    for (const doc of boardsSnapshot.docs) {
                        await doc.ref.delete();
                    }

                    console.log('‚úÖ Dados relacionados deletados');
                }

                messageDiv.innerHTML = `
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745; color: #155724;">
                        <strong>‚úÖ Usu√°rio deletado com sucesso!</strong><br>
                        Email: ${email}<br>
                        UID: ${uid}
                    </div>
                `;

                // Recarregar lista
                setTimeout(() => {
                    location.reload();
                }, 2000);

            } catch (error) {
                console.error('‚ùå Erro ao deletar usu√°rio:', error);
                
                let errorMsg = error.message;
                
                // Mensagens de erro espec√≠ficas
                if (error.code === 'permission-denied') {
                    errorMsg = 'Voc√™ n√£o tem permiss√£o para deletar este usu√°rio.';
                } else if (error.code === 'requires-recent-login') {
                    errorMsg = 'Para deletar seu pr√≥prio usu√°rio, voc√™ precisa fazer login novamente.';
                }

                messageDiv.innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545; color: #721c24;">
                        <strong>‚ùå Erro ao deletar usu√°rio:</strong><br>
                        ${errorMsg}<br><br>
                        <small>Nota: Apenas √© poss√≠vel deletar o pr√≥prio usu√°rio do Authentication. Para deletar outros usu√°rios do Auth, use o Firebase Console.</small>
                    </div>
                `;
            }
        };

        // Verificar autentica√ß√£o e carregar usu√°rios
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                loadingDiv.innerHTML = '<p style="color: #dc3545;">‚ùå Voc√™ precisa estar logado!</p>';
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }

            // Verificar se √© admin
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (!userDoc.exists || !userDoc.data().isAdmin) {
                loadingDiv.innerHTML = '<p style="color: #dc3545;">‚õî Apenas admins podem acessar esta p√°gina!</p>';
                setTimeout(() => {
                    window.location.href = 'trello-home.html';
                }, 2000);
                return;
            }

            // Carregar usu√°rios
            loadUsers();
        });
    </script>
</body>
</html>
